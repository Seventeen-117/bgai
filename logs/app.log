15:45:31.813 [main] INFO  com.bgpay.bgai.BgaiApplication - No active profile set, falling back to 1 default profile: "default"
15:45:36.413 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==>  Preparing: SELECT * FROM mime_type_config WHERE enabled = true
15:45:36.438 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==> Parameters: 
15:45:36.487 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - <==      Total: 52
15:45:36.490 [main] DEBUG c.b.b.m.F.selectAllowedTypes - ==>  Preparing: SELECT mime_type FROM allowed_file_type WHERE enabled = true
15:45:36.490 [main] DEBUG c.b.b.m.F.selectAllowedTypes - ==> Parameters: 
15:45:36.505 [main] DEBUG c.b.b.m.F.selectAllowedTypes - <==      Total: 52
15:45:37.144 [main] INFO  c.b.b.service.impl.UserServiceImpl - 初始化SSO配置: clientId=bgai-client-id, redirectUri=http://localhost:8080/api/auth/callback
15:45:37.215 [main] INFO  c.b.bgai.controller.AuthController - 初始化认证控制器: clientId=bgai-client-id, redirectUri=http://localhost:8080/api/auth/callback
15:45:39.681 [main] INFO  c.b.b.service.mq.MQConsumerService - MQ consumer startup successful [group=billing-consumer-group, topic=BILLING_TOPIC, tag=USER_BILLING]
15:45:39.847 [main] DEBUG com.bgpay.bgai.config.AsyncConfig$1 - Initializing ExecutorService 'blockingExecutor'
15:45:44.705 [main] INFO  com.bgpay.bgai.BgaiApplication - Started BgaiApplication in 15.028 seconds (process running for 16.832)
15:45:44.710 [scheduling-1] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==>  Preparing: SELECT * FROM mime_type_config WHERE enabled = true
15:45:44.711 [scheduling-1] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==> Parameters: 
15:45:44.724 [scheduling-1] DEBUG c.b.b.m.F.selectActiveMimeTypes - <==      Total: 52
15:45:44.725 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==>  Preparing: SELECT * FROM mime_type_config WHERE enabled = true
15:45:44.725 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==> Parameters: 
15:45:44.740 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - <==      Total: 52
15:45:44.740 [scheduling-1] DEBUG c.b.b.m.F.selectAllowedTypes - ==>  Preparing: SELECT mime_type FROM allowed_file_type WHERE enabled = true
15:45:44.740 [scheduling-1] DEBUG c.b.b.m.F.selectAllowedTypes - ==> Parameters: 
15:45:44.756 [scheduling-1] DEBUG c.b.b.m.F.selectAllowedTypes - <==      Total: 52
15:45:44.756 [main] DEBUG c.b.b.m.F.selectAllowedTypes - ==>  Preparing: SELECT mime_type FROM allowed_file_type WHERE enabled = true
15:45:44.757 [main] DEBUG c.b.b.m.F.selectAllowedTypes - ==> Parameters: 
15:45:44.763 [main] DEBUG c.b.b.m.F.selectAllowedTypes - <==      Total: 52
15:46:11.715 [http-nio-8080-exec-2] DEBUG c.b.b.f.ApiKeyAuthenticationFilter - Skipping API Key validation for excluded path: /api/simple-auth/token
15:46:11.988 [http-nio-8080-exec-2] DEBUG c.b.b.m.UserMapper.findByAccessToken - ==>  Preparing: SELECT * FROM t_user WHERE access_token = ? AND token_expire_time > NOW()
15:46:11.989 [http-nio-8080-exec-2] DEBUG c.b.b.m.UserMapper.findByAccessToken - ==> Parameters: d4bbd473-5bef-48b9-b0ba-ece206cb5d1d(String)
15:46:12.004 [http-nio-8080-exec-2] DEBUG c.b.b.m.UserMapper.findByAccessToken - <==      Total: 0
15:46:12.004 [http-nio-8080-exec-2] INFO  c.b.b.service.impl.UserServiceImpl - 为测试令牌创建临时用户: d4bbd473-5bef-48b9-b0ba-ece206cb5d1d
15:46:12.020 [http-nio-8080-exec-2] INFO  c.b.b.c.SimpleAuthController - 生成测试令牌: d4bbd473-5bef-48b9-b0ba-ece206cb5d1d
15:46:56.775 [http-nio-8080-exec-4] DEBUG c.b.b.f.ApiKeyAuthenticationFilter - Skipping API Key validation for excluded path: /auth/authorize
15:46:56.789 [http-nio-8080-exec-4] INFO  c.b.b.controller.MockAuthController - Authorization request: client_id=bgai-client-id, redirect_uri=http://localhost:8080/api/auth/callback, response_type=code
15:47:04.551 [http-nio-8080-exec-5] WARN  c.b.b.f.ApiKeyAuthenticationFilter - API Key is missing for path: /api/auth/callback
15:50:03.321 [SpringApplicationShutdownHook] DEBUG com.bgpay.bgai.config.AsyncConfig$1 - Shutting down ExecutorService 'blockingExecutor'
15:50:29.644 [main] INFO  com.bgpay.bgai.BgaiApplication - No active profile set, falling back to 1 default profile: "default"
15:50:33.790 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==>  Preparing: SELECT * FROM mime_type_config WHERE enabled = true
15:50:33.812 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==> Parameters: 
15:50:33.851 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - <==      Total: 52
15:50:33.854 [main] DEBUG c.b.b.m.F.selectAllowedTypes - ==>  Preparing: SELECT mime_type FROM allowed_file_type WHERE enabled = true
15:50:33.854 [main] DEBUG c.b.b.m.F.selectAllowedTypes - ==> Parameters: 
15:50:33.867 [main] DEBUG c.b.b.m.F.selectAllowedTypes - <==      Total: 52
15:50:34.527 [main] INFO  c.b.b.service.impl.UserServiceImpl - 初始化SSO配置: clientId=bgai-client-id, redirectUri=http://localhost:8080/api/auth/callback
15:50:34.604 [main] INFO  c.b.bgai.controller.AuthController - 初始化认证控制器: clientId=bgai-client-id, redirectUri=http://localhost:8080/api/auth/callback
15:50:36.834 [main] INFO  c.b.b.service.mq.MQConsumerService - MQ consumer startup successful [group=billing-consumer-group, topic=BILLING_TOPIC, tag=USER_BILLING]
15:50:36.989 [main] DEBUG com.bgpay.bgai.config.AsyncConfig$1 - Initializing ExecutorService 'blockingExecutor'
15:50:41.580 [main] INFO  com.bgpay.bgai.BgaiApplication - Started BgaiApplication in 13.868 seconds (process running for 15.198)
15:50:41.584 [scheduling-1] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==>  Preparing: SELECT * FROM mime_type_config WHERE enabled = true
15:50:41.584 [scheduling-1] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==> Parameters: 
15:50:41.593 [scheduling-1] DEBUG c.b.b.m.F.selectActiveMimeTypes - <==      Total: 52
15:50:41.594 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==>  Preparing: SELECT * FROM mime_type_config WHERE enabled = true
15:50:41.594 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==> Parameters: 
15:50:41.603 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - <==      Total: 52
15:50:41.603 [scheduling-1] DEBUG c.b.b.m.F.selectAllowedTypes - ==>  Preparing: SELECT mime_type FROM allowed_file_type WHERE enabled = true
15:50:41.603 [scheduling-1] DEBUG c.b.b.m.F.selectAllowedTypes - ==> Parameters: 
15:50:41.610 [scheduling-1] DEBUG c.b.b.m.F.selectAllowedTypes - <==      Total: 52
15:50:41.612 [main] DEBUG c.b.b.m.F.selectAllowedTypes - ==>  Preparing: SELECT mime_type FROM allowed_file_type WHERE enabled = true
15:50:41.612 [main] DEBUG c.b.b.m.F.selectAllowedTypes - ==> Parameters: 
15:50:41.617 [main] DEBUG c.b.b.m.F.selectAllowedTypes - <==      Total: 52
15:50:48.657 [http-nio-8080-exec-2] DEBUG c.b.b.f.ApiKeyAuthenticationFilter - Skipping API Key validation for excluded path: /api/auth/callback
15:51:52.238 [http-nio-8080-exec-5] DEBUG c.b.b.f.ApiKeyAuthenticationFilter - Skipping API Key validation for excluded path: /api/auth/callback
15:53:02.775 [SpringApplicationShutdownHook] DEBUG com.bgpay.bgai.config.AsyncConfig$1 - Shutting down ExecutorService 'blockingExecutor'
15:53:12.766 [main] INFO  com.bgpay.bgai.BgaiApplication - No active profile set, falling back to 1 default profile: "default"
15:53:16.971 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==>  Preparing: SELECT * FROM mime_type_config WHERE enabled = true
15:53:16.994 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==> Parameters: 
15:53:17.030 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - <==      Total: 52
15:53:17.033 [main] DEBUG c.b.b.m.F.selectAllowedTypes - ==>  Preparing: SELECT mime_type FROM allowed_file_type WHERE enabled = true
15:53:17.033 [main] DEBUG c.b.b.m.F.selectAllowedTypes - ==> Parameters: 
15:53:17.045 [main] DEBUG c.b.b.m.F.selectAllowedTypes - <==      Total: 52
15:53:17.691 [main] INFO  c.b.b.service.impl.UserServiceImpl - 初始化SSO配置: clientId=bgai-client-id, redirectUri=http://localhost:8080/api/auth/callback
15:53:17.763 [main] INFO  c.b.bgai.controller.AuthController - 初始化认证控制器: clientId=bgai-client-id, redirectUri=http://localhost:8080/api/auth/callback
15:53:20.007 [main] INFO  c.b.b.service.mq.MQConsumerService - MQ consumer startup successful [group=billing-consumer-group, topic=BILLING_TOPIC, tag=USER_BILLING]
15:53:20.150 [main] DEBUG com.bgpay.bgai.config.AsyncConfig$1 - Initializing ExecutorService 'blockingExecutor'
15:53:24.851 [main] INFO  com.bgpay.bgai.BgaiApplication - Started BgaiApplication in 14.115 seconds (process running for 15.36)
15:53:24.855 [scheduling-1] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==>  Preparing: SELECT * FROM mime_type_config WHERE enabled = true
15:53:24.856 [scheduling-1] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==> Parameters: 
15:53:24.866 [scheduling-1] DEBUG c.b.b.m.F.selectActiveMimeTypes - <==      Total: 52
15:53:24.867 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==>  Preparing: SELECT * FROM mime_type_config WHERE enabled = true
15:53:24.867 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==> Parameters: 
15:53:24.878 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - <==      Total: 52
15:53:24.878 [scheduling-1] DEBUG c.b.b.m.F.selectAllowedTypes - ==>  Preparing: SELECT mime_type FROM allowed_file_type WHERE enabled = true
15:53:24.878 [scheduling-1] DEBUG c.b.b.m.F.selectAllowedTypes - ==> Parameters: 
15:53:24.886 [scheduling-1] DEBUG c.b.b.m.F.selectAllowedTypes - <==      Total: 52
15:53:24.887 [main] DEBUG c.b.b.m.F.selectAllowedTypes - ==>  Preparing: SELECT mime_type FROM allowed_file_type WHERE enabled = true
15:53:24.887 [main] DEBUG c.b.b.m.F.selectAllowedTypes - ==> Parameters: 
15:53:24.895 [main] DEBUG c.b.b.m.F.selectAllowedTypes - <==      Total: 52
15:53:33.426 [http-nio-8080-exec-3] DEBUG c.b.b.f.ApiKeyAuthenticationFilter - Skipping API Key validation for excluded path: /api/auth/callback
15:56:32.276 [http-nio-8080-exec-4] DEBUG c.b.b.f.ApiKeyAuthenticationFilter - Skipping API Key validation for excluded path: /api/auth/callback
15:57:18.622 [SpringApplicationShutdownHook] DEBUG com.bgpay.bgai.config.AsyncConfig$1 - Shutting down ExecutorService 'blockingExecutor'
15:58:11.801 [main] INFO  com.bgpay.bgai.BgaiApplication - No active profile set, falling back to 1 default profile: "default"
15:58:16.014 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==>  Preparing: SELECT * FROM mime_type_config WHERE enabled = true
15:58:16.034 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==> Parameters: 
15:58:16.066 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - <==      Total: 52
15:58:16.068 [main] DEBUG c.b.b.m.F.selectAllowedTypes - ==>  Preparing: SELECT mime_type FROM allowed_file_type WHERE enabled = true
15:58:16.068 [main] DEBUG c.b.b.m.F.selectAllowedTypes - ==> Parameters: 
15:58:16.078 [main] DEBUG c.b.b.m.F.selectAllowedTypes - <==      Total: 52
15:58:16.710 [main] INFO  c.b.b.service.impl.UserServiceImpl - 初始化SSO配置: clientId=bgai-client-id, redirectUri=http://localhost:8080/api/auth/callback
15:58:16.777 [main] INFO  c.b.bgai.controller.AuthController - 初始化认证控制器: clientId=bgai-client-id, redirectUri=http://localhost:8080/api/auth/callback
15:58:18.985 [main] INFO  c.b.b.service.mq.MQConsumerService - MQ consumer startup successful [group=billing-consumer-group, topic=BILLING_TOPIC, tag=USER_BILLING]
15:58:19.155 [main] DEBUG com.bgpay.bgai.config.AsyncConfig$1 - Initializing ExecutorService 'blockingExecutor'
15:58:23.692 [main] INFO  com.bgpay.bgai.BgaiApplication - Started BgaiApplication in 13.737 seconds (process running for 14.996)
15:58:23.696 [scheduling-1] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==>  Preparing: SELECT * FROM mime_type_config WHERE enabled = true
15:58:23.696 [scheduling-1] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==> Parameters: 
15:58:23.705 [scheduling-1] DEBUG c.b.b.m.F.selectActiveMimeTypes - <==      Total: 52
15:58:23.706 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==>  Preparing: SELECT * FROM mime_type_config WHERE enabled = true
15:58:23.706 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==> Parameters: 
15:58:23.716 [main] DEBUG c.b.b.m.F.selectActiveMimeTypes - <==      Total: 52
15:58:23.716 [scheduling-1] DEBUG c.b.b.m.F.selectAllowedTypes - ==>  Preparing: SELECT mime_type FROM allowed_file_type WHERE enabled = true
15:58:23.716 [scheduling-1] DEBUG c.b.b.m.F.selectAllowedTypes - ==> Parameters: 
15:58:23.724 [scheduling-1] DEBUG c.b.b.m.F.selectAllowedTypes - <==      Total: 52
15:58:23.724 [main] DEBUG c.b.b.m.F.selectAllowedTypes - ==>  Preparing: SELECT mime_type FROM allowed_file_type WHERE enabled = true
15:58:23.724 [main] DEBUG c.b.b.m.F.selectAllowedTypes - ==> Parameters: 
15:58:23.729 [main] DEBUG c.b.b.m.F.selectAllowedTypes - <==      Total: 52
15:58:28.941 [http-nio-8080-exec-2] DEBUG c.b.b.f.ApiKeyAuthenticationFilter - Skipping API Key validation for excluded path: /api/auth/callback
15:59:25.221 [http-nio-8080-exec-4] DEBUG c.b.b.f.ApiKeyAuthenticationFilter - Skipping API Key validation for excluded path: /auth/authorize
15:59:25.226 [http-nio-8080-exec-4] INFO  c.b.b.controller.MockAuthController - Authorization request: client_id=bgai-client-id, redirect_uri=http://localhost:8080/api/auth/callback, response_type=code
15:59:36.349 [http-nio-8080-exec-5] DEBUG c.b.b.f.ApiKeyAuthenticationFilter - Skipping API Key validation for excluded path: /api/auth/callback
15:59:36.517 [http-nio-8080-exec-6] DEBUG c.b.b.f.ApiKeyAuthenticationFilter - Skipping API Key validation for excluded path: /auth/token
15:59:36.519 [http-nio-8080-exec-6] INFO  c.b.b.controller.MockAuthController - Token request: grant_type=null, code=null, client_id=null
15:59:36.534 [http-nio-8080-exec-8] DEBUG c.b.b.f.ApiKeyAuthenticationFilter - Skipping API Key validation for excluded path: /auth/userinfo
15:59:36.540 [http-nio-8080-exec-5] DEBUG c.b.b.mapper.UserMapper.findByUserId - ==>  Preparing: SELECT * FROM t_user WHERE user_id = ?
15:59:36.542 [http-nio-8080-exec-5] DEBUG c.b.b.mapper.UserMapper.findByUserId - ==> Parameters: 689258T(String)
15:59:36.556 [http-nio-8080-exec-5] DEBUG c.b.b.mapper.UserMapper.findByUserId - <==      Total: 1
15:59:36.637 [http-nio-8080-exec-5] DEBUG c.b.b.mapper.UserMapper.updateById - ==>  Preparing: UPDATE t_user SET user_id=?, username=?, email=?, avatar_url=?, last_login_time=?, access_token=?, refresh_token=?, token_expire_time=?, status=?, create_time=?, update_time=? WHERE id=?
15:59:36.640 [http-nio-8080-exec-5] DEBUG c.b.b.mapper.UserMapper.updateById - ==> Parameters: 689258T(String), 测试用户(String), test@example.com(String), https://ui-avatars.com/api/?name=测试用户(String), 2025-05-08T15:59:36.557652700(LocalDateTime), 918e3f31-64ce-4938-9fd4-140e28f95d2b(String), 1c99d842-44bc-469f-a431-4d4290142b7c(String), 2025-05-08T16:59:36.557652700(LocalDateTime), 1(Integer), 2025-04-26T23:59:16(LocalDateTime), 2025-05-08T15:59:36.557652700(LocalDateTime), 1(Long)
15:59:36.667 [http-nio-8080-exec-5] DEBUG c.b.b.mapper.UserMapper.updateById - <==    Updates: 1
16:00:33.770 [http-nio-8080-exec-9] INFO  c.b.b.c.ReactiveChatController - Received chat request: question length = 0, file = none, multiTurn = false
16:00:33.773 [http-nio-8080-exec-9] INFO  c.b.b.c.ReactiveChatController - Processing request for user ID: 689258T
16:00:33.773 [http-nio-8080-exec-9] ERROR c.b.b.c.ReactiveChatController - Both file and question are empty
16:02:16.420 [http-nio-8080-exec-2] INFO  c.b.b.c.ReactiveChatController - Received chat request: question length = 0, file = none, multiTurn = false
16:02:16.420 [http-nio-8080-exec-2] INFO  c.b.b.c.ReactiveChatController - Processing request for user ID: 689258T
16:02:16.420 [http-nio-8080-exec-2] ERROR c.b.b.c.ReactiveChatController - Both file and question are empty
16:03:19.459 [http-nio-8080-exec-6] INFO  c.b.b.c.ReactiveChatController - Received chat request: question length = 0, file = 新文件 17.txt, multiTurn = false
16:03:19.459 [http-nio-8080-exec-6] INFO  c.b.b.c.ReactiveChatController - Processing request for user ID: 689258T
16:03:19.459 [http-nio-8080-exec-6] INFO  c.b.b.c.ReactiveChatController - Processing file with circuit breaker: fileName=新文件 17.txt, question=
16:03:19.460 [http-nio-8080-exec-6] INFO  c.b.b.config.ReactiveFileProcessor - Processing file: 新文件 17.txt, content-type: text/plain
16:03:19.462 [http-nio-8080-exec-6] INFO  c.b.b.c.ReactiveChatController - PARAM TRACE [689258T]: 尝试查找匹配配置 - 参数: apiUrl=null, modelName=null
16:03:19.469 [http-nio-8080-exec-6] INFO  c.b.b.s.impl.ApiConfigServiceImpl - 查询配置 - userId=689258T
16:03:19.470 [http-nio-8080-exec-6] INFO  c.b.b.s.impl.ApiConfigServiceImpl - 排序方式 - 按ID降序
16:03:19.470 [http-nio-8080-exec-6] INFO  c.b.b.s.impl.ApiConfigServiceImpl - 限制结果数 - LIMIT 1
16:03:19.555 [http-nio-8080-exec-6] DEBUG c.b.b.m.ApiConfigMapper.selectList - ==>  Preparing: SELECT id,api_url,api_key,model_name,user_id FROM api_config WHERE (user_id = ?) ORDER BY id DESC LIMIT 1
16:03:19.555 [http-nio-8080-exec-6] DEBUG c.b.b.m.ApiConfigMapper.selectList - ==> Parameters: 689258T(String)
16:03:19.578 [http-nio-8080-exec-6] DEBUG c.b.b.m.ApiConfigMapper.selectList - <==      Total: 1
16:03:19.579 [http-nio-8080-exec-6] INFO  c.b.b.s.impl.ApiConfigServiceImpl - 查询结果 - 找到配置: id=2, modelName=deepseek-chat
16:03:19.579 [http-nio-8080-exec-6] INFO  c.b.b.c.ReactiveChatController - PARAM TRACE [689258T]: 找到匹配配置 - apiUrl=https://api.deepseek.com/chat/completions, modelName=deepseek-chat (原始请求: null)
16:03:19.579 [http-nio-8080-exec-6] INFO  c.b.b.c.ReactiveChatController - API config resolved: url=https://api.deepseek.com/chat/completions, model=deepseek-chat
16:03:19.580 [http-nio-8080-exec-6] INFO  c.b.b.config.ReactiveFileProcessor - File processed successfully: size=18 bytes
16:03:19.581 [http-nio-8080-exec-6] DEBUG c.b.b.c.ReactiveChatController - File+text content built, length: 38
16:03:19.582 [http-nio-8080-exec-6] INFO  c.b.b.c.ReactiveChatController - Content processed, length: 38
16:03:19.616 [http-nio-8080-exec-6] INFO  c.b.b.t.TransactionCoordinator - Transaction prepared for user 689258T: chatCompletionId=chat-d13a9b84-6dcc-4f61-befe-d32ea279325b
16:03:23.716 [scheduling-1] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==>  Preparing: SELECT * FROM mime_type_config WHERE enabled = true
16:03:23.716 [scheduling-1] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==> Parameters: 
16:03:23.726 [scheduling-1] DEBUG c.b.b.m.F.selectActiveMimeTypes - <==      Total: 52
16:03:23.727 [scheduling-1] DEBUG c.b.b.m.F.selectAllowedTypes - ==>  Preparing: SELECT mime_type FROM allowed_file_type WHERE enabled = true
16:03:23.727 [scheduling-1] DEBUG c.b.b.m.F.selectAllowedTypes - ==> Parameters: 
16:03:23.737 [scheduling-1] DEBUG c.b.b.m.F.selectAllowedTypes - <==      Total: 52
16:03:24.361 [reactor-http-nio-3] DEBUG c.b.b.m.ChatCompletionsMapper.insert - ==>  Preparing: INSERT INTO chat_completions ( object, created, model, system_fingerprint, api_key ) VALUES ( ?, ?, ?, ?, ? )
16:03:24.362 [reactor-http-nio-3] DEBUG c.b.b.m.ChatCompletionsMapper.insert - ==> Parameters: chat.completion(String), 1746691404357(Long), deepseek-chat(String), 689258T(String), chat-d13a9b84-6dcc-4f61-befe-d32ea279325b(String)
16:03:24.381 [reactor-http-nio-3] DEBUG c.b.b.m.ChatCompletionsMapper.insert - <==    Updates: 1
16:03:24.384 [reactor-http-nio-3] INFO  c.b.b.t.TransactionCoordinator - Transaction committed for user 689258T: chatCompletionId=chat-d13a9b84-6dcc-4f61-befe-d32ea279325b
16:03:24.407 [FileWrite-1] INFO  c.b.b.s.deepseek.FileWriterService - Successfully wrote content to: \var\data\ai_responses\9bf762c4-8b27-4a21-865a-45e96337a11e.txt
16:03:24.414 [boundedElastic-9] DEBUG c.b.b.m.ChatCompletionsMapper.insert - ==>  Preparing: INSERT INTO chat_completions ( object, created, model, system_fingerprint, api_key ) VALUES ( ?, ?, ?, ?, ? )
16:03:24.414 [boundedElastic-9] DEBUG c.b.b.m.ChatCompletionsMapper.insert - ==> Parameters: chat.completion(String), 1746691400(Long), deepseek-chat(String), fp_8802369eaa_prod0425fp8(String), chat-d13a9b84-6dcc-4f61-befe-d32ea279325b(String)
16:03:24.428 [boundedElastic-9] DEBUG c.b.b.m.ChatCompletionsMapper.insert - <==    Updates: 1
16:03:24.459 [boundedElastic-9] DEBUG c.b.b.mapper.UsageInfoMapper.insert - ==>  Preparing: INSERT INTO usage_info ( chat_completion_id, prompt_tokens, completion_tokens, total_tokens, prompt_tokens_cached, completion_reasoning_tokens, prompt_cache_hit_tokens, prompt_cache_miss_tokens, created_at, model_type ) VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ? )
16:03:24.459 [boundedElastic-9] DEBUG c.b.b.mapper.UsageInfoMapper.insert - ==> Parameters: chat-d13a9b84-6dcc-4f61-befe-d32ea279325b(String), 21(Integer), 5(Integer), 26(Integer), 0(Integer), 0(Integer), 0(Integer), 21(Integer), 2025-05-08T16:03:24.449588700(LocalDateTime), deepseek-chat(String)
16:03:24.480 [boundedElastic-9] DEBUG c.b.b.mapper.UsageInfoMapper.insert - <==    Updates: 1
16:03:24.561 [boundedElastic-9] INFO  c.b.b.c.ReactiveChatController - Processed response for user 689258T, content length: 9
16:03:52.669 [pool-7-thread-1] DEBUG c.b.b.m.UsageInfoMapper.selectCount - ==>  Preparing: SELECT COUNT( * ) AS total FROM usage_info WHERE (chat_completion_id = ?)
16:03:52.670 [pool-7-thread-1] DEBUG c.b.b.m.UsageInfoMapper.selectCount - ==> Parameters: chat-d13a9b84-6dcc-4f61-befe-d32ea279325b(String)
16:03:52.689 [pool-7-thread-1] DEBUG c.b.b.m.UsageInfoMapper.selectCount - <==      Total: 1
16:03:52.774 [ConsumeMessageThread_billing-consumer-group_1] DEBUG c.b.b.m.PriceConfigMapper.selectList - ==>  Preparing: SELECT id,model_type,time_period,cache_status,io_type,price,version,effective_time FROM price_config WHERE (model_type = ? AND time_period = ? AND io_type = ? AND effective_time <= ? AND cache_status = ?) ORDER BY effective_time DESC LIMIT 1
16:03:52.775 [ConsumeMessageThread_billing-consumer-group_1] DEBUG c.b.b.m.PriceConfigMapper.selectList - ==> Parameters: deepseek-chat(String), standard(String), input(String), 2025-05-08T16:03:52.772011100(LocalDateTime), miss(String)
16:03:52.788 [ConsumeMessageThread_billing-consumer-group_1] DEBUG c.b.b.m.PriceConfigMapper.selectList - <==      Total: 1
16:03:52.834 [ConsumeMessageThread_billing-consumer-group_1] DEBUG c.b.b.m.PriceConfigMapper.selectList - ==>  Preparing: SELECT id,model_type,time_period,cache_status,io_type,price,version,effective_time FROM price_config WHERE (model_type = ? AND time_period = ? AND io_type = ? AND effective_time <= ? AND cache_status IS NULL) ORDER BY effective_time DESC LIMIT 1
16:03:52.834 [ConsumeMessageThread_billing-consumer-group_1] DEBUG c.b.b.m.PriceConfigMapper.selectList - ==> Parameters: deepseek-chat(String), standard(String), output(String), 2025-05-08T16:03:52.832583700(LocalDateTime)
16:03:52.841 [ConsumeMessageThread_billing-consumer-group_1] DEBUG c.b.b.m.PriceConfigMapper.selectList - <==      Total: 1
16:03:52.899 [ConsumeMessageThread_billing-consumer-group_1] INFO  c.b.b.s.m.RocketMQBillingServiceImpl - Output price config priceVersion: 1
16:03:52.901 [ConsumeMessageThread_billing-consumer-group_1] DEBUG c.b.b.m.UsageRecordMapper.insert - ==>  Preparing: INSERT INTO usage_record ( model_type, chat_completion_id, user_id, input_cost, output_cost, price_version, calculated_at ) VALUES ( ?, ?, ?, ?, ?, ?, ? )
16:03:52.902 [ConsumeMessageThread_billing-consumer-group_1] DEBUG c.b.b.m.UsageRecordMapper.insert - ==> Parameters: deepseek-chat(String), chat-d13a9b84-6dcc-4f61-befe-d32ea279325b(String), 689258T(String), 0.0000(BigDecimal), 0.0000(BigDecimal), 1(Integer), 2025-05-08T16:03:52.899588200(LocalDateTime)
16:03:52.923 [ConsumeMessageThread_billing-consumer-group_1] DEBUG c.b.b.m.UsageRecordMapper.insert - <==    Updates: 1
16:03:52.933 [ConsumeMessageThread_billing-consumer-group_1] INFO  c.b.b.s.m.RocketMQBillingServiceImpl - Message consumed: 2408820C75288342909062BCE97060FCFB1436BAF30C277E8AED0000
16:04:38.351 [http-nio-8080-exec-5] WARN  c.b.b.f.ApiKeyAuthenticationFilter - API Key is missing for path: /api/chatGatWay-internal
16:04:51.239 [http-nio-8080-exec-9] INFO  c.b.b.c.ReactiveChatController - Received chat request: question length = 0, file = 模型 & 价格细节.xlsx, multiTurn = false
16:04:51.239 [http-nio-8080-exec-9] INFO  c.b.b.c.ReactiveChatController - Processing request for user ID: 689258T
16:04:51.239 [http-nio-8080-exec-9] INFO  c.b.b.c.ReactiveChatController - Processing file with circuit breaker: fileName=模型 & 价格细节.xlsx, question=
16:04:51.239 [http-nio-8080-exec-9] INFO  c.b.b.config.ReactiveFileProcessor - Processing file: 模型 & 价格细节.xlsx, content-type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
16:04:51.240 [http-nio-8080-exec-9] INFO  c.b.b.c.ReactiveChatController - PARAM TRACE [689258T]: 尝试查找匹配配置 - 参数: apiUrl=null, modelName=null
16:04:51.240 [http-nio-8080-exec-9] INFO  c.b.b.s.impl.ApiConfigServiceImpl - 查询配置 - userId=689258T
16:04:51.240 [http-nio-8080-exec-9] INFO  c.b.b.s.impl.ApiConfigServiceImpl - 排序方式 - 按ID降序
16:04:51.240 [http-nio-8080-exec-9] INFO  c.b.b.s.impl.ApiConfigServiceImpl - 限制结果数 - LIMIT 1
16:04:51.240 [http-nio-8080-exec-9] DEBUG c.b.b.m.ApiConfigMapper.selectList - ==>  Preparing: SELECT id,api_url,api_key,model_name,user_id FROM api_config WHERE (user_id = ?) ORDER BY id DESC LIMIT 1
16:04:51.241 [http-nio-8080-exec-9] DEBUG c.b.b.m.ApiConfigMapper.selectList - ==> Parameters: 689258T(String)
16:04:51.251 [http-nio-8080-exec-9] DEBUG c.b.b.m.ApiConfigMapper.selectList - <==      Total: 1
16:04:51.252 [http-nio-8080-exec-9] INFO  c.b.b.s.impl.ApiConfigServiceImpl - 查询结果 - 找到配置: id=2, modelName=deepseek-chat
16:04:51.252 [http-nio-8080-exec-9] INFO  c.b.b.c.ReactiveChatController - PARAM TRACE [689258T]: 找到匹配配置 - apiUrl=https://api.deepseek.com/chat/completions, modelName=deepseek-chat (原始请求: null)
16:04:51.252 [http-nio-8080-exec-9] INFO  c.b.b.c.ReactiveChatController - API config resolved: url=https://api.deepseek.com/chat/completions, model=deepseek-chat
16:04:51.252 [http-nio-8080-exec-9] INFO  c.b.b.config.ReactiveFileProcessor - File processed successfully: size=10359 bytes
16:04:51.253 [http-nio-8080-exec-9] DEBUG c.b.b.c.ReactiveChatController - File+text content built, length: 9920
16:04:51.253 [http-nio-8080-exec-9] INFO  c.b.b.c.ReactiveChatController - Content processed, length: 9920
16:04:51.267 [http-nio-8080-exec-9] INFO  c.b.b.t.TransactionCoordinator - Transaction prepared for user 689258T: chatCompletionId=chat-d95a87c9-2f7f-4ede-b49f-c21507ee7de9
16:05:16.097 [reactor-http-nio-4] DEBUG c.b.b.m.ChatCompletionsMapper.insert - ==>  Preparing: INSERT INTO chat_completions ( object, created, model, system_fingerprint, api_key ) VALUES ( ?, ?, ?, ?, ? )
16:05:16.098 [reactor-http-nio-4] DEBUG c.b.b.m.ChatCompletionsMapper.insert - ==> Parameters: chat.completion(String), 1746691516097(Long), deepseek-chat(String), 689258T(String), chat-d95a87c9-2f7f-4ede-b49f-c21507ee7de9(String)
16:05:16.131 [reactor-http-nio-4] DEBUG c.b.b.m.ChatCompletionsMapper.insert - <==    Updates: 1
16:05:16.131 [reactor-http-nio-4] INFO  c.b.b.t.TransactionCoordinator - Transaction committed for user 689258T: chatCompletionId=chat-d95a87c9-2f7f-4ede-b49f-c21507ee7de9
16:05:16.153 [FileWrite-2] INFO  c.b.b.s.deepseek.FileWriterService - Successfully wrote content to: \var\data\ai_responses\24573f93-e4e2-4c40-af56-e5ba11adf29f.txt
16:05:16.158 [boundedElastic-7] DEBUG c.b.b.m.ChatCompletionsMapper.insert - ==>  Preparing: INSERT INTO chat_completions ( object, created, model, system_fingerprint, api_key ) VALUES ( ?, ?, ?, ?, ? )
16:05:16.158 [boundedElastic-7] DEBUG c.b.b.m.ChatCompletionsMapper.insert - ==> Parameters: chat.completion(String), 1746691491(Long), deepseek-chat(String), fp_8802369eaa_prod0425fp8(String), chat-d95a87c9-2f7f-4ede-b49f-c21507ee7de9(String)
16:05:16.170 [boundedElastic-7] DEBUG c.b.b.m.ChatCompletionsMapper.insert - <==    Updates: 1
16:05:16.192 [boundedElastic-7] DEBUG c.b.b.mapper.UsageInfoMapper.insert - ==>  Preparing: INSERT INTO usage_info ( chat_completion_id, prompt_tokens, completion_tokens, total_tokens, prompt_tokens_cached, completion_reasoning_tokens, prompt_cache_hit_tokens, prompt_cache_miss_tokens, created_at, model_type ) VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ? )
16:05:16.193 [boundedElastic-7] DEBUG c.b.b.mapper.UsageInfoMapper.insert - ==> Parameters: chat-d95a87c9-2f7f-4ede-b49f-c21507ee7de9(String), 7950(Integer), 280(Integer), 8230(Integer), 7936(Integer), 0(Integer), 0(Integer), 14(Integer), 2025-05-08T16:05:16.186425300(LocalDateTime), deepseek-chat(String)
16:05:16.225 [boundedElastic-7] DEBUG c.b.b.mapper.UsageInfoMapper.insert - <==    Updates: 1
16:05:16.252 [boundedElastic-7] INFO  c.b.b.c.ReactiveChatController - Processed response for user 689258T, content length: 1226
16:05:52.483 [pool-7-thread-1] DEBUG c.b.b.m.UsageInfoMapper.selectCount - ==>  Preparing: SELECT COUNT( * ) AS total FROM usage_info WHERE (chat_completion_id = ?)
16:05:52.484 [pool-7-thread-1] DEBUG c.b.b.m.UsageInfoMapper.selectCount - ==> Parameters: chat-d95a87c9-2f7f-4ede-b49f-c21507ee7de9(String)
16:05:52.491 [pool-7-thread-1] DEBUG c.b.b.m.UsageInfoMapper.selectCount - <==      Total: 1
16:05:52.602 [ConsumeMessageThread_billing-consumer-group_2] INFO  c.b.b.s.m.RocketMQBillingServiceImpl - Output price config priceVersion: 1
16:05:52.602 [ConsumeMessageThread_billing-consumer-group_2] DEBUG c.b.b.m.UsageRecordMapper.insert - ==>  Preparing: INSERT INTO usage_record ( model_type, chat_completion_id, user_id, input_cost, output_cost, price_version, calculated_at ) VALUES ( ?, ?, ?, ?, ?, ?, ? )
16:05:52.602 [ConsumeMessageThread_billing-consumer-group_2] DEBUG c.b.b.m.UsageRecordMapper.insert - ==> Parameters: deepseek-chat(String), chat-d95a87c9-2f7f-4ede-b49f-c21507ee7de9(String), 689258T(String), 0.0000(BigDecimal), 0.0022(BigDecimal), 1(Integer), 2025-05-08T16:05:52.602254600(LocalDateTime)
16:05:52.618 [ConsumeMessageThread_billing-consumer-group_2] DEBUG c.b.b.m.UsageRecordMapper.insert - <==    Updates: 1
16:05:52.625 [ConsumeMessageThread_billing-consumer-group_2] INFO  c.b.b.s.m.RocketMQBillingServiceImpl - Message consumed: 2408820C75288342909062BCE97060FCFB1436BAF30C27803F510002
16:08:23.804 [scheduling-1] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==>  Preparing: SELECT * FROM mime_type_config WHERE enabled = true
16:08:23.804 [scheduling-1] DEBUG c.b.b.m.F.selectActiveMimeTypes - ==> Parameters: 
16:08:23.814 [scheduling-1] DEBUG c.b.b.m.F.selectActiveMimeTypes - <==      Total: 52
16:08:23.814 [scheduling-1] DEBUG c.b.b.m.F.selectAllowedTypes - ==>  Preparing: SELECT mime_type FROM allowed_file_type WHERE enabled = true
16:08:23.814 [scheduling-1] DEBUG c.b.b.m.F.selectAllowedTypes - ==> Parameters: 
16:08:23.821 [scheduling-1] DEBUG c.b.b.m.F.selectAllowedTypes - <==      Total: 52
